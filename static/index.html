from fastapi import FastAPI, HTTPException, Request
from fastapi.staticfiles import StaticFiles
import uvicorn
import json
import os
import random
import string

app = FastAPI()

# Monta la cartella static per servire i file statici
app.mount("/static", StaticFiles(directory="static"), name="static")

# Simulazione di un database per i nonce
nonce_db = {}

# Endpoint per richiedere un nonce
@app.post("/api/auth/request_nonce")
async def request_nonce(request: Request):
    data = await request.json()
    wallet_address = data.get("wallet_address")
    if not wallet_address:
        raise HTTPException(status_code=400, detail="Indirizzo wallet mancante.")
    
    nonce = ''.join(random.choices(string.ascii_letters + string.digits, k=16))
    nonce_db[wallet_address] = nonce
    return {"nonce": nonce}

# Endpoint per verificare la firma
@app.post("/api/auth/verify")
async def verify_signature(request: Request):
    data = await request.json()
    wallet_address = data.get("wallet_address")
    signature = data.get("signature")
    
    if not wallet_address or not signature:
        raise HTTPException(status_code=400, detail="Dati mancanti.")
    
    stored_nonce = nonce_db.get(wallet_address)
    if not stored_nonce:
        raise HTTPException(status_code=400, detail="Nonce non trovato.")
    
    # Simuliamo la verifica della firma (in produzione si userebbe ethers.js o web3.py)
    verified = True  # Supponiamo che la verifica vada a buon fine
    
    if not verified:
        raise HTTPException(status_code=401, detail="Firma non valida.")
    
    return {"access_token": "fake-jwt-token-for-" + wallet_address}

if __name__ == "__main__":
    uvicorn.run(app, host="0.0.0.0", port=8000)
