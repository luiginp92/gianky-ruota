<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Gira la Ruota - GiankyBot (Test)</title>
  <style>
    body { text-align: center; font-family: sans-serif; padding: 20px; }
    canvas { border: 1px solid #000; margin: 20px auto; display: block; }
    button { padding: 10px 20px; font-size: 1rem; cursor: pointer; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/2.1.3/TweenMax.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/zarocknz/javascript-winwheel@v2.7.0/Winwheel.min.js"></script>
</head>
<body>
  <h1>Test Ruota</h1>
  <canvas id="canvas" width="500" height="500"></canvas>
  <br>
  <button id="spinButton">Gira la ruota</button>
  
  <script>
    // L'array dei segmenti Ã¨ esattamente allineato con il back-end
    const prizeData = [
      { text: '10 GKY', color: '#F1C40F' },
      { text: '20 GKY', color: '#FF8C00' },
      { text: '50 GKY', color: '#E67E22' },
      { text: '100 GKY', color: '#E74C3C' },
      { text: '250 GKY', color: '#9B59B6' },
      { text: '500 GKY', color: '#3498DB' },
      { text: '1000 GKY', color: '#1ABC9C' },
      { text: 'NO PRIZE', color: '#C0392B' }
    ];
    
    const segments = prizeData.map(item => ({
      fillStyle: item.color,
      text: item.text
    }));
    
    let theWheel = new Winwheel({
      canvasId: 'canvas',
      numSegments: segments.length,
      outerRadius: 200,
      segments: segments,
      animation: {
        type: 'spinToStop',
        duration: 5,
        spins: 8,
        callbackFinished: function(indicatedSegment) {
          alert("Hai vinto: " + indicatedSegment.text);
          document.getElementById("spinButton").disabled = false;
        }
      }
    });
    
    function spinToPrize(prize) {
      // Trova l'indice del premio nell'array prizeData
      let index = prizeData.findIndex(item => item.text.trim().toUpperCase() === prize.trim().toUpperCase());
      if (index === -1) {
        index = prizeData.length - 1;
      }
      const segmentAngle = 360 / prizeData.length;
      const segmentCenter = index * segmentAngle + segmentAngle / 2;
      const extraSpins = 360 * 5;
      const stopAngle = extraSpins + (360 - segmentCenter);
      theWheel.animation.stopAngle = stopAngle;
      theWheel.startAnimation();
    }
    
    document.getElementById("spinButton").addEventListener("click", () => {
      document.getElementById("spinButton").disabled = true;
      // Supponiamo che il wallet sia salvato in localStorage (altrimenti modificalo)
      const wallet = localStorage.getItem("walletAddress");
      if (!wallet) {
        alert("Wallet non connesso.");
        document.getElementById("spinButton").disabled = false;
        return;
      }
      fetch("/api/spin", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ wallet_address: wallet })
      })
      .then(response => response.json())
      .then(data => {
        console.log("Risposta backend:", data);
        spinToPrize(data.prize);
      })
      .catch(err => {
        console.error("Errore durante lo spin:", err);
        document.getElementById("spinButton").disabled = false;
      });
    });
  </script>
</body>
</html>
