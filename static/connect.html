<script>
  async function connectWallet() {
    try {
      const provider = await web3Modal.connect();
      const web3 = new Web3(provider);
      const accounts = await web3.eth.getAccounts();
      const wallet = accounts[0];
      localStorage.setItem("walletAddress", wallet);
      document.getElementById("message").innerText = "Wallet connesso: " + wallet;

      // Richiedi il nonce dal backend
      const nonceRes = await fetch("/api/auth/request_nonce", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ wallet_address: wallet })
      });
      const nonceData = await nonceRes.json();
      if (!nonceRes.ok) {
        throw new Error(nonceData.detail || "Errore nella richiesta del nonce.");
      }
      const nonce = nonceData.nonce;
      console.log("Nonce ricevuto:", nonce);

      // Prepara il messaggio da firmare con il prefisso "GiankyStop: "
      const messageToSign = "GiankyStop: " + nonce;
      // Richiedi la firma del messaggio
      let signature;
      try {
        signature = await web3.eth.personal.sign(messageToSign, wallet, "");
      } catch (signError) {
        throw new Error("Errore nella firma: " + signError.message);
      }
      console.log("Firma ottenuta:", signature);

      // Invia wallet e firma al backend per la verifica
      const verifyRes = await fetch("/api/auth/verify", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ wallet_address: wallet, signature })
      });
      const verifyData = await verifyRes.json();
      if (!verifyRes.ok) {
        throw new Error(verifyData.detail || "Errore durante la verifica della firma.");
      }
      // Salva il token JWT in localStorage
      localStorage.setItem("jwtToken", verifyData.access_token);
      alert("Wallet collegato correttamente!");
      window.location.href = "/static/index.html";
    } catch (error) {
      console.error("Errore nella connessione del wallet:", error);
      document.getElementById("message").innerText = "Errore: " + error.message;
    }
  }

  document.getElementById('connectButton').addEventListener('click', connectWallet);
</script>
