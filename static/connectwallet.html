<script>
document.addEventListener("DOMContentLoaded", function() {
  const Web3Modal = window.Web3Modal.default;
  const WalletConnectProvider = window.WalletConnectProvider.default;
  const providerOptions = {
    walletconnect: {
      package: WalletConnectProvider, // Importante: WalletConnectProvider da Web3Modal
      options: {
        rpc: {
          137: "https://polygon-rpc.com/" // RPC URL di Polygon Mainnet
        },
        network: "matic"
      }
    }
  };

  const web3Modal = new Web3Modal({
    cacheProvider: true, // optional: Abilita o disabilita la cache del provider
    providerOptions // required
  });

  document.getElementById("connectWallet").addEventListener("click", async function() {
    try {
      const instance = await web3Modal.connect();
      const ethersProvider = new ethers.providers.Web3Provider(instance);
      const signer = ethersProvider.getSigner();
      const address = await signer.getAddress();
      document.getElementById("walletAddress").innerText = address;
      document.getElementById("walletInfo").style.display = "block";
      
      const balanceWei = await ethersProvider.getBalance(address);
      const balanceMatic = ethers.utils.formatEther(balanceWei);
      document.getElementById("maticBalance").innerText = parseFloat(balanceMatic).toFixed(4);
      
      const tokenAddress = "0x370806781689E670f85311700445449aC7C3Ff7a"; // Verifica che sia corretto
      const tokenAbi = ["function balanceOf(address owner) external view returns (uint256)"];
      const tokenContract = new ethers.Contract(tokenAddress, tokenAbi, signer);
      try {
        const tokenBalanceWei = await tokenContract.balanceOf(address);
        const tokenBalance = ethers.utils.formatEther(tokenBalanceWei);
        document.getElementById("tokenBalance").innerText = parseFloat(tokenBalance).toFixed(4);
      } catch (contractError) {
        console.error("Errore nel contratto:", contractError);
      }
    } catch(error) {
      console.error("Errore durante la connessione al wallet:", error);
      alert("Si Ã¨ verificato un errore durante la connessione al wallet. Riprova.");
    }
  });
});
</script>
